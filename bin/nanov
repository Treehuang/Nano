#!/bin/bash

CURR_DIR=$( cd "$(dirname "${BASH_SOURCE[0]}")"; pwd -P )
NANO_EXE=${CURR_DIR}/../nanov

ppid=$(pgrep -f 'nanov: master')

case $1 in
"start")
	if [[ ${ppid} != '' ]]; then
		echo -e "nano is already running..."; exit
	fi
	
	phpversion=$(php -v | grep 'PHP 7')
	if [[ ${phpversion} == '' ]]; then
		echo -e "please use php 7+"; exit
	fi
	
	php ${NANO_EXE}
	
	;;

"reload")
	if [[ ${ppid} == '' ]]; then
		echo -e "nano is not running..."; exit
	fi
	
	kill -s SIGUSR1 ${ppid}
	if [[ $? -ne 0 ]]; then
		echo -e "reload signal be sent fail..."; exit
	fi
	
	echo -e "reload signal be sent success..."
	
	;;

"quit")
	if [[ ${ppid} == '' ]]; then
		echo -e "nano is not running..."; exit
	fi
	
	kill -s SIGUSR2 ${ppid}
	if [[ $? -ne 0 ]]; then
		echo -e "quit signal be sent fail..."; exit
	fi

	echo -e "quit signal be sent success..."

	;;

"stop")
	if [[ ${ppid} == '' ]]; then
        echo -e "nano is not running..."; exit
    fi

    kill -s SIGTERM ${ppid}
    if [[ $? -ne 0 ]]; then
        echo -e "stop signal be sent fail..."; exit
    fi

    echo -e "stop signal be sent success..."

    ;;
*)

echo -e "\033[36m _   _
| \ | | __ _ _ __   _____   __
|  \| |/ _\ | '_ \ /   \ \ / /
| |\  | (_| | | | | (_) \ V /
|_| \_|\__,_|_| |_|\___/ \_/
 
\033[36mUsage :
   \033[33mnanov <param> \033[0m

\033[36mExample :
   \033[33mnanov start/quit/stop/reload \033[0m

\033[36mParams mean :
   \033[33mstop   : forcefully exit
   \033[33mquit   : gracefully exit
   \033[33mstart  : start the nanov
   \033[33mreload : gracefully quit&start the worker process \033[0m
"
esac
